<head></head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mon Profil Médical</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">

<style>
    body {
        font-family: 'Roboto', Arial, sans-serif;
        background-color: #c6c7c6;
        margin: 0;
        padding: 0;
    }
    .profile-container {
        max-width: 1200px;
 
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 24px rgba(31,111,84,0.08);
        margin: 40px auto;
         margin-left: 100px;
         margin-right: 40px;
        padding: 36px 32px 28px 32px;
        position: relative;
    }
    .profile-header {
        text-align: center;
        margin-bottom: 10px;
        padding-bottom: 20px;
    }
    .profile-header h1 {
        color: #1f6f54;
        font-size: 2em;
        margin-bottom: 6px;
    }
    .profile-header p {
        color: #07345c;
        font-size: 1.08em;
        opacity: 0.8;
    }
    .profile-avatar {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #e6f7f2;
        margin: 0 auto 16px auto;
        display: block;
        box-shadow: 0 2px 8px rgba(31,111,84,0.10);
    }
    .profile-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .form-row {
        display: flex;
        gap: 20px;
    }
    .form-group {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .profile-form label {
        color: #1f6f54;
        font-weight: 500;
        margin-bottom: 4px;
    }
    .profile-form input,
    .profile-form select {
        padding: 12px 14px;
        border: 1px solid #2f8f6f;
        border-radius: 7px;
        font-size: 1em;
        background: #f4f9f4;
        color: #07345c;
        transition: border 0.2s;
        width: 100%;
    }
    .profile-form input:focus,
    .profile-form select:focus {
        border: 2px solid #1f6f54;
        outline: none;
    }
    .profile-form button {
        background: #1f6f54;
        color: #fff;
        border: none;
        border-radius: 7px;
        padding: 14px 0;
        font-size: 1.1em;
        font-weight: bold;
        margin-top: 10px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(31,111,84,0.08);
        transition: background 0.2s;
    }
    .profile-form button:hover {
        background: #2f8f6f;
    }
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
            gap: 16px;
        }
        .profile-container {
           
            margin-left: 20px;
            margin-right: 20px;

        }
    }
    @media (max-width: 480px) {
        .profile-container {
            padding: 20px 16px;
            margin: 16px 8px;
        }
        .profile-header h1 {
            font-size: 1.6em;
        }
    }

    #retour {
                position: relative;
                margin-top: auto;
                margin-left: 600px;
                margin-right: 100px;
                margin-bottom: auto;
                /* increased size: more padding and slightly larger text for better tap targets */
                padding: 14px 20px;
                font-size: 1rem;
                background: #6f1f1f;
                color: #fff;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(31, 111, 84, 0.18);
                transition: background 0.2s, transform 0.1s;
                max-width: 800px;
                z-index: 1000;
            }

            /* Afficher l'image juste en bas de l'input de type file */
            #imagePreview {
                display: block;             /* ensure block-level positioning under the input */
                margin: 8px auto 0 auto;    /* small gap and centered under the input */
                width: 150px;               /* fixed preview size matching design */
                height: auto;
                text-align: center;
            }

            #imagePreview img {
                width: 100%;
                height: auto;
                object-fit: cover;
                border-radius: 50%;        /* circle preview */
                display: block;
            }
            /* Style pour l'input de type file pour qu'il soit plus visible et plus attractif
            et qu'il corresponde au design général
             
            */
            #profilePicture {
                display: block;
                margin: 10px auto;
                padding: 10px;
                border: 2px dashed #1f6f54;
                border-radius: 10px;
                background: #f4f9f4;
                cursor: pointer;
                transition: border-color 0.2s;
            }
</style>
</head>
<body>
    

<div class="profile-container">
    <div class="profile-header">
         <h1>Mon Profil Médical</h1>
        <div class="form-group">
            
            <input type="file" id="profilePicture" name="profilePicture" accept="image/*">
        <div id="imagePreview"  style="width: 150px; border-radius: 50%;">Image </div><!-- pour afficher l'image sélectionnée -->
    </div>

        <p>Gérez et mettez à jour vos informations personnelles et médicales en toute sécurité.</p>
    </div>
    <form class="profile-form" method="post" id="profileForm">
        <div class="form-row">
            <div class="form-group">
                <label for="nom">Nom*</label>
                <input type="text" id="nom" name="nom" required>
            </div>
            <div class="form-group">
                <label for="prenom">Prénom*</label>
                <input type="text" id="prenom" name="prenom" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="dateNaissance">Date de Naissance*</label>
                <input type="date" id="dateNaissance" name="dateNaissance" required>
            </div>
            <div class="form-group">
                <label for="sexe">Sexe*</label>
                <select id="sexe" name="sexe" required>
                    <option value="">Sélectionner...</option>
                    <option value="Homme">Homme</option>
                    <option value="Femme">Femme</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                 <label for="pays">Pays*</label>
                 <input type="text" id="pays" name="pays" required>
            </div>

            <div class="form-group">
                <label for="adresse">Adresse*</label>
                <input type="text" id="adresse" name="adresse" placeholder="Rue" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="codePostal">Code Postal*</label>
                <input type="text" id="codePostal" name="codePostal" required>
            </div>
            <div class="form-group">
                <label for="ville">Ville*</label>
                <input type="text" id="ville" name="ville" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="groupSanguin">Groupe Sanguin*</label>
                <select id="groupSanguin" name="groupSanguin" required>
                    <option value="">Sélectionner...</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                </select>
            </div>
            <div class="form-group">
                <label for="email">Email*</label>
                <input type="email" id="email" name="email" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="allergies">Allergies</label>
                <input type="text" id="allergies" name="allergies" placeholder="Liste des allergies (séparées par des virgules)">
            </div>
        </div>
        <div class="form-row">
        <div class="form-group">
            <label for="antecedents">Antécédents Médicaux</label>
            <input type="text" id="antecedents" name="antecedents" placeholder="Liste des antécédents médicaux (séparés par des virgules)">
        </div>;
        <div class="form-group">
            <label for="phone">Numéro de Téléphone</label>
            <input type="tel" id="phone" name="phone" placeholder="Numéro de téléphone">    
     </div>
     </div>

        <button type="submit" id="enreigistrer">Enregistrer</button>
    </form>


    <h2><button id="retour" type="button">Retour au Dashboard</button></h2>
</div>
 </body>

    <script>
        // Fonction pour récupérer les détails du patient depuis l'API à l'aide de son ID dans un evenement asynchrone DOMContentLoaded
    

        document.addEventListener('DOMContentLoaded', function() {

        async function loadPatientData(patientId) { 
            try {
                 const response = await fetch(`http://localhost:5103/api/Patient/${patientId}`);
                     if (!response.ok) throw new Error("Erreur lors du chargement des données du patient");
                      const patient = await response.json(); console.log("Données du patient chargées:", patient);
                      localStorage.setItem('password', patient.authentification?.password || ''); // Stocker le mot de passe dans localStorage
                        
                       // Remplir les champs du formulaire avec les données du patient 
                        document.getElementById('nom').value = patient.nom || ''; 
                        document.getElementById('prenom').value = patient.prenom || ''; 
                       //  Convertir la date de naissance au format YYYY-MM-DD pour l'input de type date 
                        const dateNaissance = new Date(patient.dateNaissance); 
                        const formattedDate = dateNaissance.toISOString().split('T')[0];
                         document.getElementById('dateNaissance').value = formattedDate || ''; 
                        document.getElementById('sexe').value = patient.sexe || '';
                         document.getElementById('pays').value = patient.adresse?.pays || ''; 
                       // // Remplir le groupe sanguin 
                        document.getElementById('groupSanguin').value = patient.profilMedical?.groupSanguin || '';
                       //  // Joindre les allergies, traitements, et antécédents en chaînes séparées par des virgules 
                        document.getElementById('allergies').value = patient.profilMedical?.allergies?.join(', ') || '';
                         document.getElementById('antecedents').value = patient.profilMedical?.antecedents?.join(', ') || ''; 
                        document.getElementById('email').value = patient.authentification?.email || ''; 
                        document.getElementById('phone').value = patient.authentification?.num_telephone || ''; 
                        document.getElementById('adresse').value = patient.adresse?.rue || 'Rue inconnue'; 
                        document.getElementById('codePostal').value = patient.adresse?.codePostal || 'Code postal inconnu';
                         document.getElementById('ville').value = patient.adresse?.ville || ' Ville inconnue'; 
                            // Afficher l'image de profil si le chemin est disponible
                         console.log("Image de profil chargée:",  patient.profilMedical?.profilePath);
                if (patient.profilMedical?.profilePath) {
                const imageUrl = patient.profilMedical.profilePath; // Ajustez selon la structure
                const imgPreview = document.getElementById('imagePreview');
                const base = 'http://localhost:5103/'; // Base URL de votre API ou serveur d'images
                imgPreview.src = imageUrl;
    //                imgPreview.alt = "Photo de profil";
                     console.log("Image de profil chargée:",base+imageUrl);

                       imgPreview.innerHTML = `<img src="${imageUrl}" alt="Profil">`;
            }

            }
            catch (err) { 
                            console.error("Erreur lors du chargement des données du patient:", err);
            } 
        } // Charger les données du patient lorsque la page se charge 

        const patientId = localStorage.getItem('patientId'); // Assurez-vous que l'ID du patient est stocké dans localStorage
       
         loadPatientData(patientId); // Charger les données du patient


            }); 


        //     // Gestion de l'aperçu de l'image de profil
        //     document.getElementById('profilePicture').addEventListener('change', function(event)
        //     {
        //         const file = event.target.files[0];
        //         if (file) {
        //             const reader = new FileReader();
        //             reader.onload = function(e) {
        //                 const img = document.createElement('img');
        //                 img.src = e.target.result;
        //                 const preview = document.getElementById('imagePreview');
        //                 preview.innerHTML = '';
        //                 preview.appendChild(img);
        //             };
        //             reader.readAsDataURL(file);
        //         }
        //     });
        // Gestion du bouton retour
        document.getElementById('retour').addEventListener('click', function() {
            window.location.href = 'dashboard-patient.html'; // Rediriger vers le tableau de bord du patient
        });

        // if(document.getElementById('enreigistrer')) {
        // document.getElementById('enreigistrer').addEventListener('click',
        //     async function(event) {
        //         event.preventDefault(); // Empêcher le comportement par défaut du formulaire
    
        //         const patientId = localStorage.getItem('patientId');
    
        //         // Récupérer les valeurs des champs du formulaire
        //         const nom = document.getElementById('nom').value;
        //         const prenom = document.getElementById('prenom').value;
        //         const dateNaissance = document.getElementById('dateNaissance').value;
        //         const sexe = document.getElementById('sexe').value;
        //         const pays = document.getElementById('pays').value;
        //         const adresseRue = document.getElementById('adresse').value;
        //         const codePostal = document.getElementById('codePostal').value;
        //         const ville = document.getElementById('ville').value;
        //         const groupSanguin = document.getElementById('groupSanguin').value;
        //         const email = document.getElementById('email').value;
        //         const allergies = document.getElementById('allergies').value.split(',').map(item => item.trim()).filter(item => item);
        //         const antecedents = document.getElementById('antecedents').value.split(',').map(item => item.trim()).filter(item => item);
        //         const phone = document.getElementById('phone').value;
    
        //         const password = localStorage.getItem('password') || '';
    
        //         // Construire l'objet patient à envoyer
        //         const patientData = {
        //             nom: nom,
        //             prenom: prenom,
        //             dateNaissance: dateNaissance,
        //             sexe: sexe,
        //             adresse: {
        //                 pays:  pays,
        //                 rue: adresseRue,
        //                 codePostal: codePostal,
        //                 ville: ville
        //             },
        //             profilMedical: {
        //                 groupSanguin: groupSanguin,
        //                 allergies: allergies,
        //                 antecedents: antecedents
        //             },
        //             authentification: {
        //                 email: email,
        //                 password: password,
        //                 num_telephone: phone
        //             }
        //         };
    
        //         try {
        //             // Envoyer la requête PUT pour mettre à jour les informations du patient
        //             const response = await fetch(`http://localhost:5103/api/Patient/${patientId}`, {
        //                 method: 'PUT',
        //                 headers: {
        //                     'Content-Type': 'application/json'
        //                 },
        //                 body: JSON.stringify(patientData)
        //             });
    
        //             if (!response.ok) {
        //                 throw new Error('Erreur lors de la mise à jour des informations du patient');
        //             }
        //             const result = await response.json();
        //             console.log("Patient mis à jour avec succès:", result);
        //             alert('Informations mises à jour avec succès !');
        //         } catch (error) {
        //             console.error('Erreur:', error);
        //             alert('Une erreur est survenue lors de la mise à jour des informations.');
        //         }
        //     });
        // }



        // fonction pour uploader l'image et récupérer le path/url
async function uploadProfileImage(patientId, file) {
    if (!file) return null;

    const formData = new FormData();
    formData.append('file', file); // côté backend on lit IFormFile file

    // n'ajoute PAS Content-Type : fetch le gère automatiquement pour FormData
    const res = await fetch(`http://localhost:5103/api/profilmedical/patient/${patientId}/image`, {
        method: 'PUT',
        body: formData,
        credentials: 'same-origin' // si tu utilises cookies/auth
    });

    if (!res.ok) {
        const text = await res.text();
        throw new Error('Échec upload image : ' + (text || res.status));
    }

    // réponse attendue : { path: 'uploads/..', url: 'http://...' }
    return await res.json();
}

// Remplacer ton handler d'enregistrement par ceci :
document.getElementById('enreigistrer').addEventListener('click', async function(event) {
    event.preventDefault();

    const patientId = localStorage.getItem('patientId');
    if (!patientId) { alert('Patient non identifié'); return; }

    // Récupérer valeurs du formulaire (comme avant)
    const nom = document.getElementById('nom').value;
    const prenom = document.getElementById('prenom').value;
    const dateNaissance = document.getElementById('dateNaissance').value;
    const sexe = document.getElementById('sexe').value;
    const pays = document.getElementById('pays').value;
    const adresseRue = document.getElementById('adresse').value;
    const codePostal = document.getElementById('codePostal').value;
    const ville = document.getElementById('ville').value;
    const groupSanguin = document.getElementById('groupSanguin').value;
    const email = document.getElementById('email').value;
    const allergies = document.getElementById('allergies').value.split(',').map(i=>i.trim()).filter(Boolean);
    const antecedents = document.getElementById('antecedents').value.split(',').map(i=>i.trim()).filter(Boolean);
    const phone = document.getElementById('phone').value;
    const password = localStorage.getItem('password') || '';

    // Construire l'objet patient (comme tu fais déjà)
    const patientData = {
        patientID:patientId,
        nom, prenom, dateNaissance, sexe,
        adresse: { pays, rue: adresseRue, codePostal, ville },
        profilMedical: { groupSanguin, allergies, antecedents },
        authentification: { email, password, num_telephone: phone }
    };

    try {
        // 1) Si un fichier est sélectionné, upload d'abord
        const fileInput = document.getElementById('profilePicture');
        const file = fileInput?.files?.[0];
        if (file) {
            // validations côté client (optionnel mais utile)
            const allowed = ['image/jpeg','image/png','image/jpg'];
            if (!allowed.includes(file.type)) {
                alert('Format d\'image non autorisé (png/jpg).');
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limite exemple
                alert('Image trop volumineuse (max 5MB).');
                return;
            }

            const uploadResult = await uploadProfileImage(patientId, file);
            // uploadResult.path ou uploadResult.url selon ton backend
//            patientData.profilMedical.profilPath = uploadResult.path || uploadResult.url;
            // si tu veux afficher immédiatement l'image renvoyée :
            const preview = document.getElementById('imagePreview');
            if (uploadResult.url && preview) {
                preview.innerHTML = `<img src="${uploadResult.url}" alt="Profil">`;
            }
        }

        // 2) Envoyer la mise à jour du patient (PUT)
        const response = await fetch(`http://localhost:5103/api/Patient/${patientId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(patientData)
        });

        if (!response.ok) {
            const errText = await response.text();
            throw new Error('Erreur mise à jour patient : ' + (errText || response.status));
        }

        const result = await response.json();
        console.log('Patient mis à jour:', result);
        alert('Informations mises à jour avec succès !');
    } catch (err) {
        console.error(err);
        alert('Une erreur est survenue : ' + err.message);
    }
});

    </script>

</html>

