<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin ‚Äî Rendez-vous</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--sidebar:#2f4858; --accent:#23a455; --muted:#9aa7ad; --card:#ffffff; --bg:#f3f7f8}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    body{margin:0;background:var(--bg);color:#24323a}
    .container{max-width:1200px;margin:28px auto;padding:18px}
    h1{margin:0 0 12px 0;color:var(--sidebar)}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(36,50,58,0.06)}
    .controls{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    .controls .left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .search input{padding:8px 12px;border-radius:8px;border:1px solid #e6ecec;width:280px}
    .filters{display:flex;gap:8px;align-items:center}
    .filter-btn{padding:6px 12px;border-radius:8px;border:1px solid #e6ecec;background:#fff;cursor:pointer;font-size:13px;transition:all 0.2s}
    .filter-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px solid #eee}
    th{color:var(--muted);font-weight:600;font-size:13px;background:#fafbfc}
    .status{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600}
    .status.programme{background:#e3f2fd;color:#1565c0}
    .status.confirme{background:#e8f5e9;color:#2e7d32}
    .status.reporte{background:#fff3e0;color:#e65100}
    .status.annule{background:#ffebee;color:#c62828}
    .time{color:var(--muted);font-size:13px}
    .actions button{margin-right:8px;padding:6px 8px;border-radius:6px;border:none;cursor:pointer;font-size:12px}
    .actions .view{background:#1f6f54;color:#fff}
    .actions .edit{background:#2f8f6f;color:#fff}
    .actions .cancel{background:#e74c3c;color:#fff}
    .no-data{padding:28px;text-align:center;color:#666}
    .loading{padding:28px;text-align:center;color:var(--muted)}
    @media(max-width:900px){
      .controls{flex-direction:column;align-items:flex-start}
      .controls .left{width:100%}
      .search input{width:100%}
      table{font-size:13px}
      .actions button{padding:4px 6px;font-size:11px}
    }

     .btn-retour {
      position:relative;
      max-width: 100px;
      bottom: auto;
      left: 50%;
      margin-top: auto;
      margin-right: 100px;
      padding: 10px 16px;
      background-color: red;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(35, 164, 85, 0.2);
      transition: background-color 0.2s, transform 0.1s;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gestion des rendez-vous</h1>

    <div class="card">
      <div class="controls">
        <div class="left">
          <div class="search">
            <input id="searchInput" placeholder="Rechercher par patient, m√©decin ou email...">
          </div>
          <div class="filters">
            <button class="filter-btn active" data-status="all">Tous</button>
            <button class="filter-btn" data-status="programme">Programm√©s</button>
            <button class="filter-btn" data-status="confirme">Confirm√©s</button>
            <button class="filter-btn" data-status="reporte">Report√©s</button>
            <button class="filter-btn" data-status="annule">Annul√©s</button>
          </div>
        </div>
        <div>
          <button id="refreshBtn" class="btn">‚ôªÔ∏è Rafra√Æchir</button>
        </div>
      </div>

      <div id="loading" class="loading">Chargement des rendez-vous...</div>
      <table id="appointmentsTable" style="display:none">
        <thead>
          <tr>
            <th>#</th>
            <th>Date/Heure</th>
            <th>Patient</th>
            <th>M√©decin</th>
            <th>Sp√©cialit√©</th>
            <th>Statut</th>
            <th>Paiement</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="appointmentsBody">
          <!-- rows injected here -->
        </tbody>
      </table>
      <div id="noData" class="no-data" style="display:none">Aucun rendez-vous trouv√©.</div>
    </div>
  </div>

 <!-- Un bouton de Retour pour retourner vers le tableau des m√©decins -->
 <button class="btn-retour" id="retour" onclick="window.location.href='admin_dashboard.html'">Retour</button>
<script>
  const apiBase = 'http://localhost:5103';
  const appointmentsBody = document.getElementById('appointmentsBody');
  const noData = document.getElementById('noData');
  const loading = document.getElementById('loading');
  const table = document.getElementById('appointmentsTable');
  const searchInput = document.getElementById('searchInput');
  const refreshBtn = document.getElementById('refreshBtn');
  const filterBtns = document.querySelectorAll('.filter-btn');

  let appointments = [];
  let currentStatus = 'all';

  function formatDateTime(d){ 
    if(!d) return '‚Äî'; 
    const dt = new Date(d); 
    return dt.toLocaleString('fr-FR', {dateStyle:'short', timeStyle:'short'}); 
  }

  function getStatusClass(status){
    const s = (status || '').toLowerCase();
    if(s.includes('programme')) return 'programme';
    if(s.includes('confirme')) return 'confirme';
    if(s.includes('reporte')) return 'reporte';
    if(s.includes('annule')) return 'annule';
    return 'programme';
  }

  function renderAppointments(list){
    appointmentsBody.innerHTML = '';
    if(!list || list.length === 0){ table.style.display='none'; noData.style.display='block'; return; }
    table.style.display='table'; noData.style.display='none';

    list.forEach((rdv, i)=>{
      const tr = document.createElement('tr');
      const statusClass = getStatusClass(rdv.etatRdv);
      const statusText = rdv.etatRdv || 'Programm√©';
      const patient = rdv.patient || {};
      const medecin = rdv.praticien || {};
      console.log(medecin);
      console.log(patient);
      const paiementText = rdv.paiement || 'Non pay√©';
      const paiementClass = paiementText.toLowerCase().includes('pay√©') ? 'confirme' : 'programme';

      tr.innerHTML = `
        <td>${i+1}</td>
        <td><div class="time">${formatDateTime(rdv.dateHeure)}</div></td>
        <td><strong>${(patient.prenom||'')+' '+(patient.nom||'')}</strong><div class="time"> ‚Äî</div></td>
        <td><strong>${(medecin.prenom||'')+' '+(medecin.nom||'')}</strong></td>
        <td>${medecin.specialite || '‚Äî'}</td>
        <td><span class="status ${statusClass}">${statusText}</span></td>
        <td><span class="status ${paiementClass}">${paiementText}</span></td>
        <td class="actions">
          <button class="view" data-id="${rdv.idRdv || rdv.id}" title="Voir d√©tails">üëÅÔ∏è</button>
          <button class="edit" data-id="${rdv.idRdv || rdv.id}" title="√âditer">‚úèÔ∏è</button>
          <button class="cancel" data-id="${rdv.idRdv || rdv.id}" title="Annuler">‚úï</button>
        </td>
      `;
      appointmentsBody.appendChild(tr);
    });

    // attach handlers
    document.querySelectorAll('.actions .view').forEach(b=>b.addEventListener('click', e=>{
      const id = e.currentTarget.dataset.id;
      alert('D√©tails du RDV: '+id);
    }));
    document.querySelectorAll('.actions .edit').forEach(b=>b.addEventListener('click', e=>{
      const id = e.currentTarget.dataset.id;
      window.location.href = `#`;
    }));
    document.querySelectorAll('.actions .cancel').forEach(b=>b.addEventListener('click', e=>{
      const id = e.currentTarget.dataset.id;
      if(confirm('Confirmer l\'annulation de ce rendez-vous ?')){
        cancelAppointment(id);
      }
    }));
  }

  async function cancelAppointment(id){
    try{
      const res = await fetch(`${apiBase}/api/RendezVous/${id}/annuler`, {method:'PATCH'});
      if(!res.ok) throw new Error('Erreur API');
      alert('Rendez-vous annul√©.');
      fetchAppointments();
    }catch(err){
      alert('Impossible d\'annuler le rendez-vous: '+err.message);
    }
  }

  function filterAndRender(){
    const q = searchInput.value.trim().toLowerCase();
    let filtered = appointments;

    // status filter
    if(currentStatus !== 'all'){
      filtered = filtered.filter(rdv => (rdv.etatRdv||'').toLowerCase().includes(currentStatus));
    }

    // search filter
    if(q){
      filtered = filtered.filter(rdv=>{
        const patient = rdv.patient || {};
        const medecin = rdv.praticien || {};
        const haystack = ((patient.prenom||'')+' '+(patient.nom||'')+' '+(patient.email||'')+' '+(medecin.prenom||'')+' '+(medecin.nom||'')+' '+(medecin.specialite||'')).toLowerCase();
        return haystack.includes(q);
      });
    }

    renderAppointments(filtered);
  }

  async function fetchAppointments(){
    loading.style.display='block'; table.style.display='none'; noData.style.display='none';
    try{
      const res = await fetch(`${apiBase}/api/RendezVous`);
      if(!res.ok) throw new Error('API error');
      const data = await res.json();
      appointments = (data || []).map(rdv=>({
        idRdv: rdv.idRdv || rdv.id,
        dateHeure: rdv.dateHeure || rdv.dateTime,
        etatRdv: rdv.etatRdv || rdv.status,
        paiement: rdv.paiement || rdv.payment,
        patient: rdv.patient || {},
        praticien: rdv.praticien || {}
      }));
      loading.style.display='none';
      filterAndRender();
    }catch(err){
      console.warn('Erreur fetching appointments, using sample data', err);
      // fallback sample
      appointments = [
        {
          idRdv:'RDV001',
          dateHeure:'2025-11-20T10:30:00',
          etatRdv:'Confirme',
          paiement:'Pay√©',
          patient:{prenom:'Abdou',nom:'Kone',email:'abdou@example.com'},
          praticien:{prenom:'Dr.',nom:'Durand',specialite:'Cardiologue'}
        },
        {
          idRdv:'RDV002',
          dateHeure:'2025-11-21T14:00:00',
          etatRdv:'Programme',
          paiement:'Non pay√©',
          patient:{prenom:'Lina',nom:'Mansouri',email:'lina@example.com'},
          praticien:{prenom:'Dr.',nom:'Ahmed',specialite:'Neurologue'}
        },
        {
          idRdv:'RDV003',
          dateHeure:'2025-11-22T09:00:00',
          etatRdv:'Reporte',
          paiement:'Pay√©',
          patient:{prenom:'Ali',nom:'Benali',email:'ali@example.com'},
          praticien:{prenom:'Dr.',nom:'Martin',specialite:'Dermatologue'}
        }
      ];
      loading.style.display='none';
      filterAndRender();
    }
  }

  // search
  searchInput.addEventListener('input', filterAndRender);

  // status filters
  filterBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      filterBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentStatus = btn.dataset.status;
      filterAndRender();
    });
  });

  refreshBtn.addEventListener('click', fetchAppointments);

  // initial load
  fetchAppointments();
</script>
</body>
</html>
