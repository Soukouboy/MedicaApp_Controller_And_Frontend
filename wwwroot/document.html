<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documents Médicaux</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="dash-med-style.css"> <!-- tu peux réutiliser ton CSS -->
</head>
<body>

  <!-- Section Documents Médicaux seulement -->
 <section class="documents-section">
  <h2><i class="fas fa-file-medical"></i> Mes ordonnances</h2>
  <div id="ordoGrid" class="documents-grid">
    <!-- cartes injectées ici -->
  </div>
</section>


  <script>
          const idPatient = localStorage.getItem('patientId');   // à récupérer dans le JWT, l'URL, etc.

      /* 1. Chargement de la liste des ordonnances */
      async function loadOrdonnances() {
        try {
          const res = await fetch(`http://localhost:5103/api/Ordonnance/${idPatient}/Patient`);
          if (!res.ok) throw new Error("Erreur réseau");
          const liste = await res.json();
          console.log(liste);

          const grid = document.getElementById('ordoGrid');
          grid.innerHTML = '';          // vide l'ancien contenu

          liste.forEach(ordo => {
            const card = document.createElement('div');
            card.className = 'document-card';
            card.innerHTML = `
              <i class="fas fa-file-prescription" style="color:#2f8f6f;"></i>
              <span>Ordonnance du ${new Date(ordo.dateCreation).toLocaleDateString()}</span>
              <button onclick="genererPDF(${ordo.idDocument})">
                <i class="fa fa-download"></i> Générer le PDF
              </button>
            `;
            grid.appendChild(card);
          });
        } catch (e) {
          console.error(e);
          alert("Impossible de charger les ordonnances.");
        }
      }

      /* 2. Génération + téléchargement du PDF */
      async function genererPDF(idDoc) {
        try {
          const res = await fetch(`http://localhost:5103/api/ordonnances/${idDoc}/download`, {
            method: 'POST',
            headers: { 'Accept': 'application/pdf' }
          });
          if (!res.ok) throw new Error("Génération impossible");

          const blob = await res.blob();                 // bytes du PDF
          const url  = window.URL.createObjectURL(blob);
          const a    = document.createElement('a');
          a.href     = url;
          a.download = `Ordonnance_${idDoc}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        } catch (e) {
          alert("Erreur lors de la création du PDF.");
        }
      }

      /* 3. Au chargement de la page */
      document.addEventListener('DOMContentLoaded', loadOrdonnances);
  </script>

</body>
</html>
